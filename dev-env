#!/usr/bin/env bash

if [[ $# -eq 0 ]]; then
  echo "Usage: dev-env subset"
  exit 1
fi

dry_run="0"
subset=$1

if [[ ! $subset =~ ^(all|scripts)$ ]]; then
  echo "Invalid subset '$subset'. Exiting."
  exit 1
fi

if [ -z "$XDG_CONFIG_HOME" ]; then
  echo "\$XDG_CONFIG_HOME not set, using ~/.config"
  XDG_CONFIG_HOME=$HOME/.config
fi

if [[ $2 == "--dry" ]]; then
  echo "Running in dry run mode."
  dry_run="1"
fi

log() {
  if [[ $dry_run == "1" ]]; then
    echo "[DRY_RUN]: $1"
  else
    echo "$1"
  fi
}

copy() {
  if [[ $dry_run == "1" ]]; then
    log "Removing: $2"
    rm "$2"
  fi

  log "Copying: $1 to $2"
  cp "$1" "$2"
}

if [[ $subset =~ ^(all|scripts)$ ]]; then
  copy "./.local/bin/compare-solution" "$HOME/.local/bin"

  # Copy helper scripts
  mkdir -p "$HOME/.local/bin/helpers"
  mkdir -p "$HOME/.journal"
  copy "./.local/bin/helpers/tmux-quicky" "$HOME/.local/bin/helpers"
  copy "./.local/bin/helpers/tmux-clone" "$HOME/.local/bin/helpers"
  copy "./.local/bin/helpers/journal" "$HOME/.local/bin/helpers"
fi

if [[ $subset == "all" ]]; then
  copy "./.zshrc" "$HOME/.zshrc"

  # Deploy .config directories
  for dir in alacritty ghostty git opencode tms tmux zed; do
    if [ -d "./.config/$dir" ]; then
      log "Deploying .config/$dir"
      mkdir -p "$XDG_CONFIG_HOME/$dir"
      if [[ $dry_run != "1" ]]; then
        cp -r "./.config/$dir/." "$XDG_CONFIG_HOME/$dir/"
      fi
    fi
  done
fi
